name: Sync Meetup Events

on:
  # Run on a schedule (daily at 8 AM Hawaii time / 6 PM UTC)
  schedule:
    - cron: '0 18 * * *'

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (preview only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      force:
        description: 'Force update all events'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# Permissions needed to commit changes
permissions:
  contents: write
  pull-requests: write

jobs:
  sync-events:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run event sync (scheduled)
        if: github.event_name == 'schedule'
        run: |
          echo "ðŸ”„ Running scheduled event sync..."
          node scripts/event-manager.js sync --verbose

      - name: Run event sync (manual with options)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "ðŸ”„ Running manual event sync..."
          FLAGS=""
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            FLAGS="$FLAGS --dry-run"
          fi
          if [ "${{ inputs.force }}" == "true" ]; then
            FLAGS="$FLAGS --force"
          fi
          node scripts/event-manager.js sync --verbose $FLAGS

      - name: Check for changes
        id: check_changes
        run: |
          git diff --name-only
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Events have been updated"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ¨ No event updates needed"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true' && inputs.dry_run != 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/data/events.ts
          git commit -m "ðŸ”„ Sync events from Meetup.com

          Auto-generated by GitHub Actions workflow
          Run ID: ${{ github.run_id }}
          Run Number: ${{ github.run_number }}"
          git push

      - name: Create sync report
        if: always()
        run: |
          echo "## ðŸ“Š Event Sync Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.dry_run }}" == "true" ]; then
            echo "- **Mode**: Dry Run (Preview Only)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ inputs.force }}" == "true" ]; then
            echo "- **Force Update**: Enabled" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "âœ… **Status**: Events updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Changes Made:" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff --stat src/data/events.ts >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "No stats available" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ¨ **Status**: No updates needed - all events are up to date" >> $GITHUB_STEP_SUMMARY
          fi

  # Optional: Create a pull request instead of direct commit
  sync-events-pr:
    runs-on: ubuntu-latest
    # Only run this job if you want PR-based updates (disabled by default)
    if: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create branch for sync
        run: |
          BRANCH_NAME="sync/events-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run event sync
        run: node scripts/event-manager.js sync --verbose

      - name: Check for changes
        id: check_changes_pr
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.check_changes_pr.outputs.has_changes == 'true'
        run: |
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add src/data/events.ts
          git commit -m "ðŸ”„ Sync events from Meetup.com"
          git push origin ${{ env.branch_name }}

      - name: Create Pull Request
        if: steps.check_changes_pr.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ env.branch_name }}
          title: 'ðŸ”„ Sync events from Meetup.com'
          body: |
            ## ðŸ“… Automated Event Sync

            This pull request contains automatic updates from Meetup.com.

            ### Changes
            - Updated events in `src/data/events.ts`
            - Synced on: ${{ github.event.repository.updated_at }}

            ### Review Checklist
            - [ ] Event descriptions look correct
            - [ ] Dates and times are accurate
            - [ ] No duplicate events
            - [ ] Images are loading properly

            ---
            *This PR was auto-generated by the event sync workflow*
          labels: |
            automated
            events
            sync