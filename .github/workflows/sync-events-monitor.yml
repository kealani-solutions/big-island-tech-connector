name: Monitor Event Sync

on:
  workflow_run:
    workflows: ["Sync Meetup Events"]
    types:
      - completed

jobs:
  notify-on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Create issue for failed sync
        uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            const title = `ðŸš¨ Event Sync Failed - ${date}`;

            // Check if issue already exists for today
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'sync-failure',
              state: 'open'
            });

            const existingIssue = issues.data.find(issue =>
              issue.title.includes(date)
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: `## Event Sync Failure Report

The automated event sync from Meetup.com has failed.

**Workflow Run**: [View logs](${context.payload.workflow_run.html_url})
**Time**: ${new Date().toUTCString()}
**Run ID**: ${context.payload.workflow_run.id}

### Possible Causes
- Meetup.com website structure changed
- Network connectivity issues
- Authentication problems
- Rate limiting

### Recommended Actions
1. Check the workflow logs for specific error messages
2. Run sync manually with verbose flag: \`node scripts/event-manager.js sync --verbose\`
3. Check if Meetup.com is accessible
4. Review recent changes to the sync script

### Manual Sync Command
\`\`\`bash
npm install
node scripts/event-manager.js sync --verbose
\`\`\`

---
*This issue was automatically created by the sync monitor workflow*`,
                labels: ['sync-failure', 'automated', 'bug']
              });
            }

  check-sync-health:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Log successful sync
        run: |
          echo "âœ… Event sync completed successfully"
          echo "Time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Run ID: ${{ github.event.workflow_run.id }}"